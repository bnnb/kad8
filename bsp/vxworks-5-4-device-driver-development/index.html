<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="false"><head>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>VxWorks 5.4 Device Driver Development &middot; VxWorks</title>
  <meta name="title" content="VxWorks 5.4 Device Driver Development &middot; VxWorks" />
  
  <meta name="description" content="VxWorks 5.4 device driver development" />
  <meta name="keywords" content="VxWorks 5.4, Tornado, " />
  
  
  <link rel="canonical" href="https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.67eb0befb1fb57e6528684f3a2ff6e0606a82100504705b66488d54a9f3fda9c2605c9bf3b70163208427288637a7b4d1a168384c1115e417458eae6b44b329c.css"
    integrity="sha512-Z&#43;sL77H7V&#43;ZShoTzov9uBgaoIQBQRwW2ZIjVSp8/2pwmBcm/O3AWMghCcohjentNGhaDhMERXkF0WOrmtEsynA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.efbf3b6b987689fffaf2d7b73173d2690c0279a04d444b0537a77d7f4ff6e6d493445400cb0cf56bc0f0f123e19f15394e63cae34e67f069bd013dd5c73df56e.js"
    integrity="sha512-7787a5h2if/68te3MXPSaQwCeaBNREsFN6d9f0/25tSTRFQAywz1a8Dw8SPhnxU5TmPK405n8Gm9AT3Vxz31bg==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:url" content="https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/">
  <meta property="og:site_name" content="VxWorks">
  <meta property="og:title" content="VxWorks 5.4 Device Driver Development">
  <meta property="og:description" content="VxWorks 5.4 device driver development">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="bsp">
    <meta property="article:published_time" content="2024-10-05T19:18:03+08:00">
    <meta property="article:modified_time" content="2024-10-05T19:18:03+08:00">
    <meta property="article:tag" content="VxWorks 5.4">
    <meta property="article:tag" content="Tornado">
    <meta property="og:image" content="https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/featured-Tornado-and-vxworks.png">
      <meta property="og:see_also" content="https://www.kad8.com/bsp/booting-vxworks-with-altera-cyclone-v/">
      <meta property="og:see_also" content="https://www.kad8.com/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/featured-Tornado-and-vxworks.png">
  <meta name="twitter:title" content="VxWorks 5.4 Device Driver Development">
  <meta name="twitter:description" content="VxWorks 5.4 device driver development">

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Board Support Package",
    "name": "VxWorks 5.4 Device Driver Development",
    "headline": "VxWorks 5.4 Device Driver Development",
    "description": "VxWorks 5.4 device driver development",
    "abstract": "\u003ch1 class=\u0022relative group\u0022\u003ePreface \n    \u003cdiv id=\u0022preface\u0022 class=\u0022anchor\u0022\u003e\u003c\/div\u003e\n    \n    \u003cspan\n        class=\u0022absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100\u0022\u003e\n        \u003ca class=\u0022group-hover:text-primary-300 dark:group-hover:text-neutral-700\u0022\n            style=\u0022text-decoration-line: none !important;\u0022 href=\u0022#preface\u0022 aria-label=\u0022Anchor\u0022\u003e#\u003c\/a\u003e\n    \u003c\/span\u003e        \n    \n\u003c\/h1\u003e\n\u003cp\u003eThis guide is for device driver developers, who have general background in real time operating systems. This guide addresses device driver development using VxWorks 5.4\/Tornado 2.0.\u003c\/p\u003e",
    "inLanguage": "en",
    "url" : "https:\/\/www.kad8.com\/bsp\/vxworks-5-4-device-driver-development\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-10-05T19:18:03\u002b08:00",
    "datePublished": "2024-10-05T19:18:03\u002b08:00",
    
    "dateModified": "2024-10-05T19:18:03\u002b08:00",
    
    "keywords": ["VxWorks 5.4","Tornado"],
    
    "mainEntityOfPage": "true",
    "wordCount": "6501"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj&#43;KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1543398821442998"
  crossorigin="anonymous"></script>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BP06TX4782"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-BP06TX4782');
  </script>
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">VxWorks</span>

            
            <img src="/img/VxWorks_logo.png" width="151" height="130"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="VxWorks" />
            

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">VxWorks</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/training/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Training
    </p>
</a>



            
            
  <a href="/bsp/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        BSP
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/training/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Training
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/bsp/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            BSP
        </p>
    </a>
</li>




                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      VxWorks 5.4 Device Driver Development
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-10-05T19:18:03&#43;08:00">5 October 2024</time><span class="px-2 text-primary-500">&middot;</span><span>6501 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">31 mins</span>
  

  
  
</div>





<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/vxworks-5.4/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    VxWorks 5.4
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/tornado/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Tornado
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#tasks">Tasks</a></li>
    <li><a href="#scheduler">Scheduler</a></li>
    <li><a href="#mutual-exclusion">Mutual Exclusion</a></li>
    <li><a href="#semaphores">Semaphores</a></li>
    <li><a href="#message-queues">Message Queues</a></li>
    <li><a href="#network-intertask-communication">Network Intertask Communication</a></li>
    <li><a href="#additional-facilities">Additional Facilities</a></li>
  </ul>

  <ul>
    <li><a href="#serial-driver">Serial Driver</a></li>
  </ul>

  <ul>
    <li><a href="#context-switching">Context Switching</a></li>
    <li><a href="#reentrancy">Reentrancy</a></li>
    <li><a href="#priority-inheritance">Priority inheritance</a></li>
    <li><a href="#address-space">Address space</a></li>
    <li><a href="#cache-coherency">Cache Coherency</a></li>
    <li><a href="#implementing-select-call">Implementing Select Call</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#tasks">Tasks</a></li>
    <li><a href="#scheduler">Scheduler</a></li>
    <li><a href="#mutual-exclusion">Mutual Exclusion</a></li>
    <li><a href="#semaphores">Semaphores</a></li>
    <li><a href="#message-queues">Message Queues</a></li>
    <li><a href="#network-intertask-communication">Network Intertask Communication</a></li>
    <li><a href="#additional-facilities">Additional Facilities</a></li>
  </ul>

  <ul>
    <li><a href="#serial-driver">Serial Driver</a></li>
  </ul>

  <ul>
    <li><a href="#context-switching">Context Switching</a></li>
    <li><a href="#reentrancy">Reentrancy</a></li>
    <li><a href="#priority-inheritance">Priority inheritance</a></li>
    <li><a href="#address-space">Address space</a></li>
    <li><a href="#cache-coherency">Cache Coherency</a></li>
    <li><a href="#implementing-select-call">Implementing Select Call</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = decodeURIComponent(e.attr('id'));
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
           
            $(e).removeClass('active').siblings('ul').hide();
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
         
          $toc.find('a').parent('li').find('ul').hide();
        
        onScroll();
      });
    }
  })();


</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" >
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        BSP - This article is part of a series.
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://www.kad8.com/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/">
            Part 1: Using VxWorks BSP With Zynq 7000 Ap Soc
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 2: This Article
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://www.kad8.com/bsp/booting-vxworks-with-altera-cyclone-v/">
            Part 3: Boot VxWorks With Altera Cyclone V
        </a>
    </div>
    
    


</details>



        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Preface 
    <div id="preface" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#preface" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>This guide is for device driver developers, who have general background in real time operating systems. This guide addresses device driver development using VxWorks 5.4/Tornado 2.0.</p>
<p>We referred to VxWorks 5.4 programmers manual and other <a href="https://www.vxworks.net" target="_blank">VxWorks</a> website to make sure the content is as accurate as possible.</p>


<h1 class="relative group">Real Time Operating System and VxWorks 
    <div id="real-time-operating-system-and-vxworks" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#real-time-operating-system-and-vxworks" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Operating systems can be categorized into real-time and non-real-time systems. A real-time system is defined as a system where the response time for an event is predictable and deterministic with minimal latency. The architecture of the operating system&rsquo;s scheduler, also referred to as the dispatcher, has a significant impact on the responsiveness of the OS. Preemptive scheduling ensures the highest priority task/thread always runs and doesn’t relinquish the CPU until its work is done or a higher priority task becomes available. A preemptive scheduler also implies a real-time kernel. Several aspects to consider when selecting a real-time OS are:</p>
<ul>
<li>Foot print of the kernel</li>
<li>Interrupt latency</li>
<li>Interrupt response time</li>
<li>Interrupt recovery</li>
<li>Multi-tasking</li>
<li>Task context switching</li>
<li>Virtual memory support</li>
</ul>
<p>VxWorks provides a real-time kernel that interleaves the execution of multiple tasks employing a scheduling algorithm. Thus the user sees multiple tasks executing simultaneously. VxWorks uses a single common address space for all tasks thus avoiding virtual-to-physical memory mapping. Complete virtual memory support is available with the optional vxMem library.</p>


<h1 class="relative group">Tour of VxWorks 
    <div id="tour-of-vxworks" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tour-of-vxworks" aria-label="Anchor">#</a>
    </span>        
    
</h1>


<h2 class="relative group">Tasks 
    <div id="tasks" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tasks" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>A task is an independent program with its own thread of execution and execution context. Every task contains a structure called the task control block that is responsible for managing the task&rsquo;s context. A task&rsquo;s context includes</p>
<ul>
<li>program counter or thread of execution</li>
<li>CPU registers</li>
<li>Stack of dynamic variables and function calls</li>
<li>Signal handlers</li>
<li>IO assignments</li>
<li>Kernel control structures</li>
</ul>
<p>Every task has a name and an ID associated with it. Each task is assigned a default priority as well. A task has four states as shown below.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /bsp/vxworks-5-4-device-driver-development/VxWorks-task-status_hu778240746616876669.png 330w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-task-status_hu5077000666592835956.png 660w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-task-status_hu12861952951176633739.png 1024w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-task-status_hu16510092732078188328.png 2x"
        src="/bsp/vxworks-5-4-device-driver-development/VxWorks-task-status_hu5077000666592835956.png"
        alt="VxWorks Task Status"
      />
      
    </figure>
</p>
<p>A task can be created with <code>taskInit()</code> and then activated with <code>taskActivate()</code> routine or both these actions can be performed in a single step using <code>taskSpawn()</code>. Once a task is created it is set to the suspend state and suspended until it is activated, after which it is added to the ready queue to be picked up by the scheduler and run. A task may be suspended by either the debugging your task, or the occurrence an exception. The difference between the pend and suspend states is that a task pends when it is waiting for a resource. A task that is put to sleep is added to delay queue.</p>


<h2 class="relative group">Scheduler 
    <div id="scheduler" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#scheduler" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VxWorks scheduler determines which task to own the CPU time. By default, the scheduler runs a preemptive algorithm. Preemptive scheduler guarantees that the highest priority task preempts a lower priority task. There are some special cases called priority inversion which is discussed in advanced concepts.</p>
<p>The scheduler can be set to run round robin algorithm which is a time slicing algorithm.</p>


<h2 class="relative group">Mutual Exclusion 
    <div id="mutual-exclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#mutual-exclusion" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Mutual exclusion can be implemented in VxWorks in the following three ways.</p>
<ul>
<li>Semaphores</li>
<li>Disabling Interrupts</li>
<li>Disabling the scheduler using <code>taskLock()</code></li>
</ul>


<h2 class="relative group">Semaphores 
    <div id="semaphores" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#semaphores" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VxWorks supports three types of semaphores, binary, mutual exclusion, and counting, each of which is optimized for a specific application. Semaphores are generally used for task synchronization and communication, and protection of shared resources also referred to as concurrency control or mutual exclusion.</p>
<ul>
<li>Binary semaphores are the fastest and are best suited for basic task synchronization and communication.</li>
<li>Mutual exclusion semaphores are sophisticated binary semaphores that are designed to address the issues relating to task priority inversion and semaphore deletion in a multitasking environment.</li>
<li>Counting semaphores maintain a count of the number of times a resource is given. This is useful when an action is required for each event occurrence. For example if you have ten buffers, and multiple tasks can grab and release the buffers, then you want to limit the access to this buffer pool using a counting semaphore.</li>
</ul>


<h2 class="relative group">Message Queues 
    <div id="message-queues" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#message-queues" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VxWorks supports messages queues for inter task communication. A variable number of messages, each of variable length, can be sent to any task. ISRs and tasks can send messages but only tasks can receive messages.</p>
<p>Multiple tasks can wait on a single message queue and can be ordered by their priority. Messages can be marked urgent for faster delivery.</p>


<h2 class="relative group">Network Intertask Communication 
    <div id="network-intertask-communication" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#network-intertask-communication" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VxWorks supports general facilities like pipes, sockets, RPC and signals for network inter task communications.</p>


<h2 class="relative group">Additional Facilities 
    <div id="additional-facilities" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#additional-facilities" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>VxWorks provides facilities like Asynchronous IO and buffered IO for application and driver development. It is also POSIX library.</p>


<h1 class="relative group">Interrupts and Interrupt handling 
    <div id="interrupts-and-interrupt-handling" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#interrupts-and-interrupt-handling" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Interrupt is the mechanism by which a device seeks the attention of CPU. The piece of user code that the CPU executes on interrupt is called interrupt service routine (ISR). The Kernel doesn&rsquo;t transfer execution to the ISR immediately. It does some house keeping before the ISR is executed. The delay between the occurrence of interrupt and time spent by the kernel before it executes the first ISR instruction is called Interrupt response time. This equals the sum of interrupt latency and time to save CPU&rsquo;s context and execution time of kernel ISR entry function.</p>
<p>VxWorks provides a special context for interrupt service code to avoid task context switching, and thus renders fast response. VxWorks supplies interrupt routines which connect to C functions and pass arguments to the functions to be executed at interrupt level. To return from an interrupt, the connected function simply returns. A routine connected to an interrupt in this way is referred to as an interrupt service routine (ISR) or interrupt handler. When an interrupt occurs, the registers are saved, a stack for the arguments to be passed is set up, then the C function is called. On return from the ISR, stack and registers are restored.</p>
<p><code>IntConnect(INUM_TO_IVEC(intNum), intHandler, argToHandler)</code> allows C functions to be connected to any interrupt. The first argument to this routine is the byte offset of the interrupt vector to connect to. The second argument is the interrupt handler and the last is any argument to this handler.</p>
<p>One can disable interrupts using <code>intLock()</code> for synchronization. Care should be taken to re-enable the interrupts using <code>intUnlock()</code>. If you are planning for nested interrupts, you should not disable interrupts using <code>intLock()</code>. Also make sure that your code is reentrant and you allocate enough stack resources for nesting.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<ul>
<li>Within an ISR, limited capabilities exist for the user code. Not all library functions are available.</li>
<li>Since memory facilities malloc() and free() take semaphores, they cannot be called within ISR.</li>
<li>Any blocking call is to be avoided.</li>
<li>Semaphores can be given, but not taken from an ISR.</li>
</ul>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<p>ISR can communicate with user tasks via</p>
<ul>
<li>shared memory and ring buffers</li>
<li>release of semaphores</li>
<li>signal tasks</li>
<li>writing to pipes</li>
<li>sending messages using message queue</li>
</ul>
<p>Understanding ISR and what goes on within interrupt handler is the key to designing your driver. Many real world drivers just have an interrupt handler and interact with user and device without the rest of the interfaces. Please refer to 7) for examples.</p>


<h1 class="relative group">Devices and Drivers 
    <div id="devices-and-drivers" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#devices-and-drivers" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>A driver supplies a uniform device independent logical interface to the user to interact with a device. A device can be a piece of hardware such as your hard drive or can be a piece of software such as a pipe or a socket, but a driver is always a software module. A driver can control multiple devices. If the architecture allows virtual memory, driver works in a logical/virtual address space, but a device works in a physical address space.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /bsp/vxworks-5-4-device-driver-development/VxWorks-device-driver-interaction_hu12406421107407906191.png 330w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-device-driver-interaction_hu15872755337968007918.png 660w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-device-driver-interaction_hu7509666448277733967.png 1024w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-device-driver-interaction_hu7325073326225427555.png 2x"
        src="/bsp/vxworks-5-4-device-driver-development/VxWorks-device-driver-interaction_hu15872755337968007918.png"
        alt="VxWorks Device Driver Interaction"
      />
      
    </figure>
</p>
<p>All interactions with devices in VxWorks are performed through the IO sub-system. VxWorks treats all devices as files. Devices are opened just like normal files are for IO operations. An example device is <code>/tyCo/0</code> that represents a serial channel. When a filename is specified in an IO call by the user task, the IO system searches for a device with a name that matches the specified filename. Two most important devices are character devices or non-block and block devices. Character devices perform IO operations character by character. Block devices are used for storing file systems. Block devices perform IO in blocks of characters and can support complicated operations such as random access. Block devices are accessed via file system routines as shown in the above figure. The driver interface to character devices are not filesystem routines.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<ul>
<li>A character device is named usually at the system initialization</li>
<li>Block devices are always associated with a file system like raw file system, dos file system. They are named when initialized for a specific file system.</li>
<li>Drivers can be loaded and unloaded dynamically.</li>
<li>Drivers work in thee context of the task invoked an interface routine. Hence drivers are preemptable and should be designed as such.</li>
</ul>


<h1 class="relative group">Character Drivers 
    <div id="character-drivers" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#character-drivers" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>creat(), remove(), open(), close(), read(), write(), ioctl() are the seven standard driver interfaces that can be exposed to the user. Not all of the interfaces are mandatory.</p>
<p>Four steps are involved in the driver design and install process.</p>
<ol>
<li>Step 1: Decide the interfaces you want to expose and install the driver</li>
</ol>
<p>The following piece of code is the driver initialization routine.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDrv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">myDrvNum</span> <span class="o">=</span> <span class="nf">iosDrvInstall</span><span class="p">(</span><span class="n">myDevCreate</span> <span class="cm">/* create */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">    			<span class="mi">0</span> <span class="cm">/* remove() is null */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">myDevOpen</span> <span class="cm">/* open() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="mi">0</span> <span class="cm">/* close() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">myDevRead</span> <span class="cm">/* read() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">myDevWrite</span> <span class="cm">/* write() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">myDevIoctl</span> <span class="cm">/* ioctl() */</span>
</span></span><span class="line"><span class="cl">			<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* connect the ISR */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">intConnect</span><span class="p">(</span><span class="n">intvec</span><span class="p">,</span> <span class="n">myIntHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As shown in the above piece of code, we can skip the driver interface routines like remove and close. But it is always a good practice to include them and return an error. VxWorks returns an error on your behalf, if it doesn&rsquo;t find a particular interface. Also you can initialize any relevant data structures in the myDrv routine.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<ul>
<li>myDrvNum is used by the IO subsystem in locating your device.</li>
<li>The device driver gets installed into a driver table. The index is based on driver number. Since a driver can service more then one device, a list of devices are tied together in a linked list, with the same driver number, but different device names and device descriptors.</li>
</ul>
<ol start="2">
<li>Step 2: Create your device descriptor structure</li>
</ol>
<p>Capture the essence of your device in a structure. This structure will hold all the information related to your device. This structure will be passed back by the IO subsystem, as a parameter to the rest of the interfaces like read(), write(), ioctl() etc., You can even get this structure within your ISR.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEV_HDR</span> <span class="n">myDevHdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">isDevAvailable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">getAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">MY_DEV</span><span class="p">;</span>
</span></span></code></pre></div><p>If you are using semaphores to control the access to your device, make sure you create and initialize them before you make use of them.</p>
<p>Once you are ready with your structure, pass it as an address to <code>iosDevAdd</code> as shown in the below piece of code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDevCreate</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="err">…</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MY_DEV</span> <span class="o">*</span><span class="n">pMyDevice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="nf">iosDevAdd</span><span class="p">(</span><span class="n">pMyDevice</span><span class="p">,</span> <span class="cm">/* pointer to MY_DEV device */</span>
</span></span><span class="line"><span class="cl">		       <span class="n">name</span><span class="p">,</span> <span class="cm">/* input param */</span>
</span></span><span class="line"><span class="cl">		       <span class="n">myDrvNum</span> <span class="cm">/* return value from iosDrvInstall */</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* do other work as necessary */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>iosDevAdd</code> takes three arguments. The first argument is the address of device descriptor structure. A device descriptor structure always starts with DEV_HDR structure as it&rsquo;s first member. It can contain any other private data structures for your own use. The second argument is the name of the device. The third argument is the driver number, the return value of <code>iosDrvInstall</code>.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<p>IO subsystem searches the correct device based on device name and driver number. They are held in a header structure DEV_HDR.</p>
<ol start="3">
<li>Step 3: Finish the definitions of all other interfaces</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDevOpen</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pMyDev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">additionalInfo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDevRead</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pMyDev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* read nBytes from the device and put them into the buffer*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDevWrite</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pMyDev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* write to the device from buffer if the device has room*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>IOCTL needs some explanation. It is through IOCTL that a user can control the device. This the preferred way of controlling the device. The code within the IOCTL depends upon the way your device perform and the way you want to control the device.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myDevIoctl</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pMyDev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">CASE</span> <span class="nl">SET_DEVICE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* set the device */</span>
</span></span><span class="line"><span class="cl">	<span class="n">CASE</span> <span class="nl">MODIFY_PARAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol start="4">
<li>Step 4: Complete your interrupt handler</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Void</span> <span class="nf">myIntHandler</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* disable any further interrupts */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">intLock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// now read the interrupt register and indicate to the other tasks that you received an interrupt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// You can do this in multiple ways. Refer to &#39;Tour of VxWorks&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// One easy way is to give a semaphore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">semGive</span><span class="p">(</span><span class="n">getAccess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* re-enable interrupts*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">intUnlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Once your interrupt handler has been installed using intConnect(), the kernel will call your ISR when the CPU receives an interrupt from the device.</p>


<h1 class="relative group">Block Drivers 
    <div id="block-drivers" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#block-drivers" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>A block device is a device that is organized as a sequence of individually accessible blocks of data. A block is the smallest addressable unit on a block device. Block devices have a slightly different interface than that of other IO drivers. Rather than interacting directly with the IO system, block drivers interact via file-system. The file system in turn interacts with the IO system. Every block device is typically associated with a specific file system. DOS, SCCI, and raw file systems are supported.</p>
<p>Block devices are divided into two categories based on their write capabilities. Direct Access BLOCK Devices are slightly different from SEQUENTIAL Devices in that data can be written only to the end of written medium for sequential devices, where as for true block devices, data can be written any where randomly.</p>
<p>There is no difference between BLOCK and Sequential devices as far as reading from the device is concerned.</p>
<p>A device driver for a block device must provide a means for creating logical device structure, a BLK_DEV for direct access block devices and SEQ_DEV for sequential block devices. BLK_DEV/SEQ_DEV structures describe the device, contain routines to access the device, describe the device in a general fashion so that the underlying file system that serves this device can know about this device.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<ul>
<li>When the driver creates the block device, the device has no name or file system associated with it. These are assigned during the device initialization routine for the specific file system (example dosFsDevInit()).</li>
<li>The low-level driver is not installed in the IO system driver table. Instead the underlying file system is installed as an entry into the driver table. Only one entry of file system is installed even if multiple devices are using this file system.</li>
</ul>
<p>The following three steps are involved in writing a Block device driver. I shall explain this example by using ram driver with DOS as the underlying file system.</p>
<p>Ram driver emulates a disk driver, but actually keeps all data in memory. The memory location and size are specified when the &ldquo;disk&rdquo; is created. The RAM disk feature is useful when data must be preserved between boots of VxWorks or when sharing data between CPUs. The RAM driver is called in response to <code>ioctl()</code> codes in the same manner as a normal disk driver. When the file system is unable to handle a specific <code>ioctl()</code> request, it is passed to the <code>ramDrv</code> driver. Although there is no physical device to be controlled, <code>ramDrv</code> does handle a <code>FIODISKFORMAT</code> request, which always returns OK. All other ioctl() requests return an <code>error</code> and set the task&rsquo;s errno to <code>S_ioLib_UNKNOWN_REQUEST</code>.</p>
<ol>
<li>Step 1: Initialize and finish the interfaces within BLK_DEV structure
Declare all your data structures, create your semaphores, initialize the interrupt vectors and enable the interrupts just as been discussed for character devices.</li>
</ol>
<p>This step is required, only when you are creating your own device and not making use of existing block devices (like ram drive, scsi device etc.,) supported by VxWorks. Check VxWorks reference manual and programmers guide before you fill out the interfaces.</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >Points to remember</span>
</div>

<p>If these interfaces are filled, the file system will call them for you, if not it will call the default routines of the file system itself.</p>
<p>BLK_DEV is a structure that has the address of certain routines. If you decided to fill the structure, just declare the required interfaces and pass the address of the interfaces to BLK_DEV.</p>
<p>Declare your private device descriptor structure. Or you can directly use BLK_DEV structure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BLK_DEV</span> <span class="n">myDev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Bool</span> <span class="n">privateData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">giveAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">DEVICE</span><span class="p">;</span>
</span></span></code></pre></div><p>The various fields within BLK_DEV structure are</p>
<p>bd_blkRd: Address of driver routine that reads blocks from the device, if your device is myBlkDevice, then call this routine as myBlkDevRd.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myBlkDevRd</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">DEVICE</span> <span class="o">*</span> <span class="n">pDev</span><span class="p">,</span>	<span class="cm">/* pointer to driver&#39;s device descriptor.
</span></span></span><span class="line"><span class="cl"><span class="cm">					 * The file system passes the address of BLK_DEV structure.
</span></span></span><span class="line"><span class="cl"><span class="cm">					 * These two are equivalent because BLK_DEV is the first item of DEVICE structure */</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">startBlk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">numBlks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Char</span> <span class="o">*</span> <span class="n">pBuf</span>		<span class="cm">/*the address where data read is copied to */</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span></code></pre></div><p>bd_blkWrt: Address of driver routine that writes blocks to the device</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myBlkDevWrt</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">DEVICE</span> <span class="o">*</span> <span class="n">pDev</span><span class="p">,</span>	<span class="cm">/* pointer to driver&#39;s device descriptor. */</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">startBlk</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">numBlks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">Char</span> <span class="o">*</span> <span class="n">pBuf</span>		<span class="cm">/*the address where data is copied from and written to the device */</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span></code></pre></div><p>bd_ioctl: Address of driver routine that performs the device IO control</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myBlkDevIoctl</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">DEVICE</span> <span class="o">*</span> <span class="n">pDev</span><span class="p">,</span>	<span class="cm">/* pointer to driver’s device descriptor. */</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">functioncode</span><span class="p">,</span>  <span class="cm">/* ioctl function code */</span>
</span></span><span class="line"><span class="cl">		<span class="n">Int</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span></code></pre></div><p>bd_reset: Address of driver routine that performs the device reset. Null if none</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myBlkDevReset</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">DEVICE</span> <span class="o">*</span> <span class="n">pDev</span><span class="p">,</span>	<span class="cm">/* pointer to driver’s device descriptor. */</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span></code></pre></div><p>bd_statusChk: Address of driver routine that checks the device status. Null if none</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">myBlkDevStatus</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="n">DEVICE</span> <span class="o">*</span> <span class="n">pDev</span><span class="p">,</span> <span class="cm">/* pointer to driver’s device descriptor. */</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span></code></pre></div><p>bd_removable: TRUE if the device is removable(like floppy)</p>
<p>bd_nBlocks: Total number of blocks on the device</p>
<p>bd_nbytesPerBlk</p>
<p>bd_lksPerTrack</p>
<p>bd_nHeads</p>
<p>bd_retry: Number of times to retry failed reads or writes</p>
<p>bd_mode: Deice mode (write protected etc.,), typically set to O_RDWR</p>
<p>bd_readyChanged: True if the device ready status has changed. Defaults to true</p>
<p>A similar structure SEQ_DEV needs to be filled if your device is sequential.</p>
<ol start="2">
<li>Step 2: Create your device</li>
</ol>
<p>Include your header files for the file system library. In our case it is dos file system. The libaray is dosFsLib.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BLK_DEV</span> <span class="o">*</span><span class="n">pBlkDev</span><span class="p">;</span>	<span class="c1">// declare your BLK_DEV structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DOS_VOL_DESC</span> <span class="o">*</span><span class="n">pVolDesc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">PBlkDev</span> <span class="o">=</span> <span class="nf">ramDevCreate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">PvolDesc</span> <span class="o">=</span> <span class="nf">dosFsMkfs</span><span class="p">(</span><span class="s">&#34;DEV1:&#34;</span><span class="p">,</span> <span class="n">PblkDev</span><span class="p">);</span>
</span></span></code></pre></div><p>Explanation about the above code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">BLK_DEV</span> <span class="o">*</span><span class="nf">ramDevCreate</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span> <span class="n">ramAddr</span><span class="p">,</span> <span class="cm">/* where it is in memory (0 = malloc) */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">bytesPerBlk</span><span class="p">,</span> <span class="cm">/* number of bytes per block */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">blksPerTrack</span><span class="p">,</span> <span class="cm">/* number of blocks per track */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">nBlocks</span><span class="p">,</span> <span class="cm">/* number of blocks on this device */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">blkOffset</span> <span class="cm">/* no. of blks to skip at start of device */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>if you have already pre-allocated memory, pass the address as the first argument. If not, VxWorks will allocate memory on your behalf using malloc, if you pass zero as the first argument.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DOS_VOL_DESC</span> <span class="o">*</span><span class="nf">dosFsMkfs</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span> <span class="n">volName</span><span class="p">,</span> <span class="cm">/* volume name to use */</span>
</span></span><span class="line"><span class="cl">	<span class="n">BLK_DEV</span> <span class="o">*</span> <span class="n">pBlkDev</span> <span class="cm">/* pointer to block device struct */</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>dosFsMkfs routine calls dosFsDevInit() with default parameters and initializes the file system on the disk by calling ioctl() with FIODISKINIT.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">DOS_VOL_DESC</span> <span class="o">*</span><span class="nf">dosFsDevInit</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span> <span class="o">*</span> <span class="n">devName</span><span class="p">,</span> <span class="cm">/* device name */</span>
</span></span><span class="line"><span class="cl">	<span class="n">BLK_DEV</span> <span class="o">*</span> <span class="n">pBlkDev</span><span class="p">,</span> <span class="cm">/* pointer to block device struct */</span>
</span></span><span class="line"><span class="cl">	<span class="n">DOS_VOL_CONFIG</span> <span class="o">*</span> <span class="n">pConfig</span> <span class="cm">/* pointer to volume config data */</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>This routine takes a block device structure (BLK_DEV) created by a device driver and defines it as a dosFs volume. As a result, when high-level I/O operations (e.g., open(), write()) are performed on the device, the calls will be routed through dosFsLib. The pBlkDev parameter is the address of the BLK_DEV structure which describes this device. This routine associates the name devName with the device and installs it in the VxWorks I/O system’s device table. The driver number used when the device is added to the table is that which was assigned to the dosFs library during dosFsInit(). (The driver number is placed in the global variable dosFsDrvNum.)</p>
<p>The BLK_DEV structure contains configuration data describing the device and the addresses of five routines which will be called to read sectors, write sectors, reset the device, check device status, and perform other control functions (ioctl()). These routines will not be called until they are required by subsequent I/O operations.</p>
<p>The pConfig parameter is the address of a DOS_VOL_CONFIG structure. This structure must have been previously initialized with the specific dosFs configuration data to be used for this volume. This structure may be easily initialized using dosFsConfigInit(). If the device being initialized already has a valid dosFs (MS-DOS) file system on it, the pConfig parameter may be NULL. In this case, the volume will be mounted and the configuration data will be read from the boot sector of the disk. (If pConfig is NULL, both change-no-warn and auto-sync options are initially disabled. These can be enabled using the dosFsVolOptionsSet() routine.)</p>
<ol start="3">
<li>Step 3: Finish your ISR</li>
</ol>
<p>Finish your interrupt handler routine. You just need to connect the ISR using intConnect.</p>


<h1 class="relative group">Real World Scenarios 
    <div id="real-world-scenarios" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#real-world-scenarios" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>I will cover two sample drivers. The first one is a standard serial driver. The second one is a hypothetical network processor driver, which doesn&rsquo;t follow the required conventions. Both of these are character drivers.</p>


<h2 class="relative group">Serial Driver 
    <div id="serial-driver" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#serial-driver" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This driver deals with PowerPC 8245 DUART. You can download PPC 8245 manual online from here MPC8245. Look into chapter 11 and 12 of this manual. This example deals with NS16550 or equivalent UART (Universal Asynchronous Receiver Transmitter).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// forward declare our interrupt handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">DuartISRHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define EUMBARR_BASE	DEFINE_YOUR_OWN
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DUART_CH1_IVR	EUMBARR_BASE+0x51120
</span></span></span><span class="line"><span class="cl"><span class="cp">#define IACK_REG	EUMBARR_BASE+0x600A0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define EOI_REG		EUMBARR_BASE+0x600B0
</span></span></span></code></pre></div><p>Embedded utilities Block(EUMBARR) holds the EPIC register definition. It serves as an offset for the rest of the registers within EPIC unit. The programming model of EPIC is as follows.</p>
<ul>
<li>set the required interrupt vector/priority register. In this case we are interested in DUART channel 1 IVR.</li>
<li>Once an interrupt occurs, EPIC will notify the CPU. CPU has to read the interrupt acknowledge register to determine the interrupt source. Most of the times this portion will be taken care for your by the BSP(Board support package) and the kernel. But I will show you how to do this. Typically your kernel will determine the source and call the installed interrupt handler.</li>
<li>Once you have finished your work within ISR, you have to return. Your kernel will typically write to EOI register. I will show this step too.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define		DCR	EUMBARR_BASE+0x4511
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		ULCR	EUMBARR_BASE+0x4503
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UFCR	EUMBARR_BASE+0x4502
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UIIR	UFCR
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		URBR	EUMBARR_BASE+0x4500
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UTHR	URBR
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UDLB	URBR
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UIER	EUMBARR_BASE+0x4501
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UDMB	UIER
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		ULSR	EUMBARR_BASE+0x4505
</span></span></span><span class="line"><span class="cl"><span class="cp">#define		UDSR	EUMBARR_BASE+0x4510
</span></span></span></code></pre></div><p>Let us get into details about the DUART itself . Refer to 12.3 DUART initialization sequence.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * declare buffersize to be  greater then 14.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * This the value we set for FIFO capacity, 14 bytes of data.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * We make use of a ring buffer to handle the incoming and out going data.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A ring Buffer is a circular array (liner array around which we wrap around).
</span></span></span><span class="line"><span class="cl"><span class="cm"> * */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define BUF_SIZE 141
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DEV_HDR</span> <span class="n">DuartHdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Char</span> <span class="n">readBuf</span><span class="p">[</span><span class="n">BUF_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">Char</span> <span class="n">writeBuf</span><span class="p">[</span><span class="n">BUF_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">readCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">readPtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">writePtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">writeCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOL</span> <span class="n">intUse</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">getRDAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Semaphore</span> <span class="n">getWRAccess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">MY_DEV</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* some global definitions */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MY_DEV</span> <span class="n">gDuartStruct</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Static</span> <span class="kt">int</span> <span class="n">gDuartDrvNum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartInit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ULSR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* This lets access to UDLB, UAFR and UDMB. */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">UDLB</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">UDMB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* we have set divisor to be 16, the max baud rate allowed. */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">UAFR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* disable concurrent writes */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ULSR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* set bit 8 bit characters (bits 0 and 1) */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">DCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* route the interrupts to EPIC in four signal mode */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">UIER</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* we are not setting modem status. We program assuming no modem is going to be connected. */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">UFCR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* enable the FIFO Tx and Rx for 14 bytes */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">DUART_CH1_IVR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>         <span class="cm">/* clear it first; */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">priority</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>          <span class="cm">/* actual priority will be 1 */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>           <span class="cm">/*  the vector number associated with UART interrupt.
</span></span></span><span class="line"><span class="cl"><span class="cm">				    * make sure no one else has this vector already taken.
</span></span></span><span class="line"><span class="cl"><span class="cm">				    * It returns vector 128 when IACK register is read.
</span></span></span><span class="line"><span class="cl"><span class="cm">				    * */</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">DUART_CH1_IVR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">priority</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vector</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">gDuartDrvNum</span> <span class="o">=</span> <span class="nf">iosDrvInstall</span><span class="p">(</span><span class="n">myDevCreate</span> <span class="cm">/* create */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="mi">0</span> <span class="cm">/* remove() is null */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">DuartOpen</span> <span class="cm">/* open() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">DuartClose</span> <span class="cm">/* close() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">DuartRead</span> <span class="cm">/* read() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">DuartWrite</span> <span class="cm">/* write() */</span> <span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="n">DuartIoctl</span> <span class="cm">/* ioctl() */</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// register our ISR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">intConnect</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">DuartISRHandler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">getWRAccess</span> <span class="o">=</span> <span class="nf">semBCreate</span><span class="p">(</span><span class="n">SEM_Q_PRIORITY</span><span class="p">,</span> <span class="n">SEM_FULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">getRDAccess</span> <span class="o">=</span> <span class="nf">semBCreate</span><span class="p">(</span><span class="n">SEM_Q_PRIORITY</span><span class="p">,</span> <span class="n">SEM_EMPTY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Inside the DuartInit routine, we initialized various registers. One point to note is we created two semaphores, one for read and one for write. They protect the read and write buffers readBuf and writeBuf. getWRAccess has been created full, meaning the write semaphore is available immediately for access, which indicates that the user can write to the DUART and writeBuf can hold bytes. getRDAccess has been created empty, meaning there is no data available for reading immediately from readBuf, until someone gives the semaphore.</p>
<p>Semaphores are taken in read and write routines and given in the ISR. ISR can modify readPtr and writeCount. It doesn&rsquo;t modify writePtr and readCount. DuratRead() routines modifies readCount and doesn&rsquo;t modify readPtr. DuratWrite() routine modifes writePtr and doesn&rsquo;t modify writeCount. This way, I am making sure that no race conditions exisit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartCreate</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="err">…</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">MY_DEV</span> <span class="o">*</span><span class="n">pDuart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gDuartStruct</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span> <span class="o">=</span> <span class="nf">iosDevAdd</span><span class="p">(</span><span class="n">pDuart</span><span class="p">,</span>  <span class="cm">/* pointer to MY_DEV device */</span>
</span></span><span class="line"><span class="cl">                       <span class="n">name</span><span class="p">,</span>    <span class="cm">/* input param */</span>
</span></span><span class="line"><span class="cl">                       <span class="n">gDuartDrvNum</span>     <span class="cm">/* return value from iosDrvInstall */</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartOpen</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pDuart</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">remainder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* serial devices should have no file name remainder */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* if multiple opens occur, we reject, note that I have not protected inUse variable here. They should be protected */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">remainder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">intUse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">intUse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// only one access at a time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pDuart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartClose</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="err">…</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">intUse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// read from the DUART and Put it into the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1">// here we will not always be able to read the required number of bytes for two reasons.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1) Not enough data is available
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2) We code it little lazy, and the user has to do one more read to get the data, if readPtr has wrapped around
</span></span></span><span class="line"><span class="cl"><span class="c1">// we manipulate pDuart-&gt;readPtr only in the ISR and pDuart-&gt;readCount from this code to avoid race conditions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartRead</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pDuart</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* read nBytes from the device and put them into the buffer */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* define RDMASK and WRITEMASK */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">RDMASK</span><span class="p">)</span>  <span class="c1">// if it is readable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* this is a blocking call.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * If there is no data available, we cannot proceed further,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * until data arrives and we release the semaphore from the ISR.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">semTake</span><span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">getRDAccess</span><span class="p">,</span> <span class="n">WAIT_FOREVER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* grab whatever data is available and return it,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * don&#39;t wait till you get all the required nBytes data.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">NumBytestoRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">readPtr</span> <span class="o">=</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readPtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NumBytestoRead</span> <span class="o">=</span> <span class="n">readPtr</span> <span class="o">-</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span> <span class="o">&gt;=</span> <span class="n">readPtr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// no race condition detected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">while</span> <span class="p">((</span><span class="n">NumBytestoRead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span> <span class="o">&gt;</span> <span class="n">readPtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">buffer</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readBuf</span><span class="p">[</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span><span class="o">++</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span> <span class="o">%=</span> <span class="n">BUF_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">NumBytestoRead</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span> <span class="o">&lt;</span> <span class="n">readPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">((</span><span class="n">NumBytestoRead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span> <span class="o">&lt;</span> <span class="n">readPtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">buffer</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readBuf</span><span class="p">[</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">readCount</span><span class="o">++</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">I</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">NumBytestoRead</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">I</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* write to the device from buffer if the device has room */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// We manipulate the writePtr from here and writeCount from the ISR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartWrite</span><span class="p">(</span><span class="n">MY_DEV</span> <span class="o">*</span> <span class="n">pDuart</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// define RDMASK and WRITEMASK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WRITEMASK</span><span class="p">)</span>       <span class="c1">// if it is writeable mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">NumBytestoWrite</span> <span class="o">=</span> <span class="n">nBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Int</span> <span class="n">writeCount</span> <span class="o">=</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writeCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span> <span class="o">&gt;=</span> <span class="n">writeCount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// no race condition detected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">while</span> <span class="p">((</span><span class="n">NumBytestoWrite</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span> <span class="o">&gt;=</span> <span class="n">writeCount</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writeBuf</span><span class="p">[</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">I</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span> <span class="o">%=</span> <span class="n">BUF_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">NumBytestoWrite</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span> <span class="o">&lt;</span> <span class="n">writeCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">((</span><span class="n">NumBytestoWrite</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">writeCount</span> <span class="o">&gt;=</span> <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writeBuf</span><span class="p">[</span><span class="n">pDuart</span><span class="o">-&gt;</span><span class="n">writePtr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">I</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">NumBytestoWrite</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">I</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>IOCTL requires some explanation. IOCTL provides an interface for a user to control the device, and is the preferred way of controlling the device. The implementation of IOCTL is dependant upon the way your device performs and how you want to control the device.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">STATUS</span> <span class="nf">DuartIoctl</span><span class="p">(</span><span class="n">MY_DEV</span><span class="o">*</span> <span class="n">pDuart</span><span class="p">,</span>  <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baudrate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">CASE</span> <span class="nl">SET_DEVICE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="cm">/* set the device*/</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="n">CASE</span> <span class="nl">MODIFY_BAUD</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">// our argument has the new baud rate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="c1">// we will have to modify the registers to set the baud rate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="c1">// you need to know the clock frequency of your CPU.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="c1">// assume it is a global value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="n">clock_frequency</span><span class="o">/</span> <span class="p">(</span><span class="n">baud</span><span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                              <span class="c1">// UDLB is the least significant byte register and UDMB is the most significant.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="c1">// each register is 8 bits wide, so the max value for 8 bits  of data is 255.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="c1">// if divisor is less then 256, we assign it to UDLB and make UDMB zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                              <span class="nf">If</span><span class="p">(</span><span class="n">divisor</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                              <span class="p">{</span>
</span></span><span class="line"><span class="cl">			      	<span class="o">*</span><span class="n">UDLB</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                              <span class="p">}</span>
</span></span><span class="line"><span class="cl">                              <span class="k">else</span>
</span></span><span class="line"><span class="cl">                              <span class="p">{</span>
</span></span><span class="line"><span class="cl">                              	<span class="o">*</span><span class="n">UDMB</span> <span class="o">=</span> <span class="n">divisor</span> <span class="o">-</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="o">*</span><span class="n">UDLB</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                              <span class="p">}</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                  <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Let us finish the interrupt handler routine. We enter into the handler after the kernel has determined that the vector within IACK register matches to DuartISRHandler.</p>
<p>// The logic for the code is as follows</p>
<ul>
<li>read interrupt read register UIIR</li>
<li>if error occurred, read ULSR</li>
<li>read URBR, if data is recd. This will clear the UIIR</li>
<li>write to UTHR, if FIFO is empty. This will clear the UIIR</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define lastThreeBits	(1 &lt;&lt; 3) | (1 &lt;&lt; 2) | (1 &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RxLineError	(1 &lt;&lt; 2) | (1 &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RxDataAvailable	(1 &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define charTimeOut	(1 &lt;&lt; 3) | (1 &lt;&lt; 2)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define uthrEmpty	(1 &lt;&lt; 1)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define RFE		(1 &lt;&lt; 7)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define FE		(1 &lt;&lt; 3)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TxEmpty   	(1 &lt;&lt; 6)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define TxHrEmpty  	(1 &lt;&lt; 5)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DuartISRHandler</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">oldlevel</span> <span class="o">=</span> <span class="nf">intLock</span><span class="p">();</span>	<span class="c1">// let us lock interrupts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regUIIR</span> <span class="o">=</span> <span class="o">*</span><span class="n">UIIR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">regUIIR</span> <span class="o">&amp;</span> <span class="n">lastThreeBits</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// we handle both cases in the same fashion
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">CASE</span> <span class="nl">RxLineError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">CASE</span> <span class="nl">uthrEmpty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ULSR gives us the status of the interrupt that just occurred on the DURAT.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regULSR</span> <span class="o">=</span> <span class="o">*</span><span class="n">ULSR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">regULSR</span> <span class="o">&amp;</span> <span class="n">RFE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Framing Error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">logMsg</span><span class="p">(</span><span class="s">&#34;Framing Error DUART&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">((</span><span class="n">regULSR</span> <span class="o">&amp;</span> <span class="n">TxEmpty</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">regULSR</span> <span class="o">&amp;</span> <span class="n">TxHrEmpty</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Tx is empty, we can write more to the device.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span> <span class="o">&gt;</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writePtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">While</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">UDSR</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span> <span class="o">&gt;=</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writePtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="o">*</span><span class="n">UTHR</span> <span class="o">=</span> <span class="n">writeBuf</span><span class="p">[</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span><span class="o">++</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">					<span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span> <span class="o">%=</span> <span class="n">BUF_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">						
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span> <span class="o">&lt;=</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writePtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">UDSR</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span> <span class="o">&lt;=</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writePtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="o">*</span><span class="n">UTHR</span> <span class="o">=</span> <span class="n">writeBuf</span><span class="p">[</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">writeCount</span><span class="o">++</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">								
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// indicate to the user that write buffer can be filled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">semGive</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">getWRAcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>      <span class="c1">// end case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>								
</span></span><span class="line"><span class="cl">		<span class="n">CASE</span> <span class="nl">RxDataAvailable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span> <span class="o">&gt;</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">UDSR</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span> <span class="o">&gt;</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readCount</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">readBuf</span><span class="p">[</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">URBR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span> <span class="o">%=</span> <span class="n">BUF_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span> <span class="o">&lt;</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readCount</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">UDSR</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readCount</span> <span class="o">&gt;=</span> <span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">readBuf</span><span class="p">[</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">readPtr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">URBR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// indicate to the user that read buffer has more data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">semGive</span><span class="p">(</span><span class="n">gDuartStruct</span><span class="p">.</span><span class="n">getRDAcess</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">intUnlock</span><span class="p">(</span><span class="n">oldlevel</span><span class="p">);</span>    <span class="c1">// re-enable interrupts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>Once we left the ISR, the kernel will call EOI (end of Interrupt) and will notify the CPU.</p>
<p>In the real world however, many times you will not be using all the interface functions. So your design will not involve adding a device (<code>iosDevAdd</code>), installing interfaces (<code>iosDrvInstall</code>) etc,.</p>
<p>You directly declare your ISR and connect it to a particular vector. After that you can communicate to your device back and forth via interrupts and via user task that processes the responses from the ISR.</p>
<p>Here is a diagram which helps you understand more clearly.</p>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /bsp/vxworks-5-4-device-driver-development/VxWorks-user-task-and-isr_hu2502306467321201566.png 330w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-user-task-and-isr_hu3216991138594749676.png 660w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-user-task-and-isr_hu4924277142585158936.png 1024w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-user-task-and-isr_hu4542027869607514721.png 2x"
        src="/bsp/vxworks-5-4-device-driver-development/VxWorks-user-task-and-isr_hu3216991138594749676.png"
        alt="VxWorks User Task and ISR"
      />
      
    </figure>
</p>


<h1 class="relative group">User Interaction with a driver 
    <div id="user-interaction-with-a-driver" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#user-interaction-with-a-driver" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Once you have compiled your driver module, you can link it statically or load it dynamically.</p>
<p>For the DUART driver to be used, you have to install the device and add the device. You can modify your DuartInit routine to automatically call DuartCreate function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">fd</span> <span class="o">=</span> <span class="nf">DuartCreate</span><span class="p">(</span><span class="s">&#34;/duart0&#34;</span><span class="p">);</span>
</span></span></code></pre></div><p>Make sure your DuartInit is called during your system initialization, say at the end of SysHardwareInit()</p>
<p>Write a user application to use the duart by using the following code.</p>
<p>Open the device with required permissions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span><span class="p">((</span><span class="n">fd</span><span class="o">=</span><span class="nf">open</span><span class="p">(</span><span class="s">&#34;/duart0&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0666</span><span class="p">))</span> <span class="o">==</span> <span class="n">ERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// you can read and write to the device
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For debugging your driver, connect your Tornado and use GDB.</p>


<h1 class="relative group">Advanced Topics 
    <div id="advanced-topics" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#advanced-topics" aria-label="Anchor">#</a>
    </span>        
    
</h1>


<h2 class="relative group">Context Switching 
    <div id="context-switching" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#context-switching" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>When the scheduler preempts a task it has to store the current state of the task in task&rsquo;s context storage area and will retrieve it later when the task is resumed. The current runnable tasks context is retrieved. This process of switching the contexts is called task switching or context switching.</p>
<ul>
<li>The highest priority task always runs till it requires no CPU time.</li>
<li>Higher priority tasks that are made ready preempt the currently executing task.</li>
<li>A context switch can occur by the currently executing task relinquishing control, or a higher priority task becoming ready. A currently executing task can relinquish control via a blocking call, which suspends task execution until the blocking requirement is met, or if a timeout of a blocking call invoked by a higher priority task occurs. A higher priority task may become available also via a blocking call requirement fulfilled resulting in the operating system performing a context switch, or a timeout on a blocking call occurring as previously mentioned. Interrupt handlers and currently executing tasks are common ways to initiate a context switch that results in the execution of a higher priority task.</li>
<li>Interrupt Service Routines (ISR) do not have a persistent context. ISRs have a transient execution context that executes at a higher priority than a task. Therefore, interrupt handlers preempt a task irrespective of the task&rsquo;s priority. Due to the transient nature of ISRs, they should not perform any blocking operation and therefore can not invoke a system call, or any routine, that does such. An ISR that attempts to block will more than likely result with the system in a deadlock state. Therefore special attention should be given to any calls made, or actions taken, from within the context of an ISR.</li>
<li>It is possible for an ISR to preempt another ISR, however this is board dependent and may not be allowed. The handling of the hardware interrupt, that in turn invokes the ISR registered for the interrupt, is board specific and is performed by the board support package software (BSP). VxWorks provides an API that allows the developer to register an ISR with the BSP&rsquo;s board specific handler. This abstraction layer allows for board specific code to be segregated from the remainder of the application thus allowing for easier porting to new board types.</li>
<li>You can tell the system not to preempt your code by using taskLock() and release it later once you finished your critical section code using taskUnlock(). Note this is not a suggested mechanism, as your code cannot be interrupted. Also this might lead to unacceptable real time behavior, because a higher priority task can preempt a lower priority task that locked itself.</li>
</ul>


<h2 class="relative group">Reentrancy 
    <div id="reentrancy" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#reentrancy" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>If a piece of code can be used by more then one task without the fear of data corruption, then it is said to be Reentrant. A reentrant function can be interrupted at any time and resumed latter without loss or corruption of data.</p>
<p>To achieve reentrancy, use either local variables (i.e variables on stack rather then on heap, and CPU registers etc.,) or treat the code as critical section and protect the data. Most library routines are reentrant within VxWorks. If a function ends with _r(), then it is non reentrant.</p>


<h2 class="relative group">Priority inheritance 
    <div id="priority-inheritance" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#priority-inheritance" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Assume three tasks t1, t2, t3 with task priorities p1, p2, p3 such that p1 &gt; p2 &gt; p3. If task t3 is currently executing and holds access to shared resource s1 (ex. by holding a semaphore sem1), and if t1 preempts t3 and wants to access s1 via the sem1, t1 will be suspended as soon as it wants to access sem1, which is held by t3. So to prevent deadlock, priority of task t3 will be made greater than or equal to that of t1 (i.e p3 &gt;= p1) till t3 gives the semaphore and relinquishes it&rsquo;s access to s1. Tasks t2 and t1 cannot preempt t3 until t3 gives sem1.</p>
<p>To support priority inversion, RTOS should support dynamic priorities.</p>


<h2 class="relative group">Address space 
    <div id="address-space" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#address-space" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>In VxWorks, all code and text live together in a single address space. (VxWorks has come up with new version called AE which has different user and kernel address spaces). So if your code is poorly written, it can actually enter the kernel text and corrupt the OS, which can cause some serious problems. Having a single common address space improves the performance of your system. When you are using virtual memory, you still have to map between virtual and physical memory within your driver.</p>


<h2 class="relative group">Cache Coherency 
    <div id="cache-coherency" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#cache-coherency" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>
    <figure>
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /bsp/vxworks-5-4-device-driver-development/VxWorks-cpu-cache_hu1449043587279361621.png 330w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-cpu-cache_hu13586222788157757025.png 660w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-cpu-cache_hu8100203199942978279.png 1024w,
        /bsp/vxworks-5-4-device-driver-development/VxWorks-cpu-cache_hu12282585550443693846.png 2x"
        src="/bsp/vxworks-5-4-device-driver-development/VxWorks-cpu-cache_hu13586222788157757025.png"
        alt="VxWorks CPU Cache"
      />
      
    </figure>
</p>
<p>Depending upon your processor and BSP design, typically CPU caches data and instructions for improved performance. If you are DMAing data between your device and RAM, then your driver should guarantee cache coherency. This is typically done in two ways.</p>
<ul>
<li>Mark a portion of memory within your RAM as non-cachable. Allocate cache safe buffers from this memory.</li>
<li>Alternatively, use cacheFlush() and cacheInvalidate() routines provided by VxWorks. If Device is reading data from RAM, first flush the cache and then read data. If Device is writing to RAM, write to RAM and then invalidate the cache immediately. This way CPU&rsquo;s cache will be in sync with RAM.</li>
</ul>


<h2 class="relative group">Implementing Select Call 
    <div id="implementing-select-call" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#implementing-select-call" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Select call lets your driver support multiple devices and a task can wait on all or some of these devices at the same time for at least one of the devices to be ready for IO. These tasks can specify timeout period for the devices to become ready.</p>
<p>Most of the functionality for select call is supported in <code>selectLib</code> library. Your <code>ioctl()</code> is called whenever user calls select() with an argument <code>FIOSELECT</code>. To support select() call,</p>
<ol>
<li>Declare <code>SEL_WAKEUP_LIST</code> as part of your device descriptor structure and initialize it by calling <code>selWakeupList</code> within your <code>xxDevCreate()</code> routine.</li>
<li>Add <code>SEL_WAKEUP_NODE</code>, which is the third argument to your ioctl(), to the wakeup list.</li>
<li>Use <code>selWakeupType</code> to determine if the task is waiting for read or write.</li>
<li>If the device is ready, call <code>selWakeupAll</code>, to unblock all tasks waiting.</li>
<li>Implement FIOUNSELECT to delete a node</li>
</ol>

          
          
          
        </div>
        
        

        
<details style="margin-left:0px" class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5">
    
    <summary
        class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        BSP - This article is part of a series.
    </summary>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://www.kad8.com/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/">
            Part 1: Using VxWorks BSP With Zynq 7000 Ap Soc
        </a>
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 2: This Article
    </div>
    
    
    
    <div
        class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        <a href="https://www.kad8.com/bsp/booting-vxworks-with-altera-cyclone-v/">
            Part 3: Boot VxWorks With Altera Cyclone V
        </a>
    </div>
    
    


</details>

        
  
  <section class="flex flex-row flex-wrap justify-center pt-4 text-xl">
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;title=VxWorks%205.4%20Device%20Driver%20Development"
      title="Share on LinkedIn"
      aria-label="Share on LinkedIn"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://twitter.com/intent/tweet/?url=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;text=VxWorks%205.4%20Device%20Driver%20Development"
      title="Tweet on Twitter"
      aria-label="Tweet on Twitter"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://bsky.app/intent/compose?text=VxWorks%205.4%20Device%20Driver%20Development&#43;https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/"
      title="Post on Bluesky"
      aria-label="Post on Bluesky"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256,232.562c-21.183,-41.196 -78.868,-117.97 -132.503,-155.834c-51.378,-36.272 -70.978,-29.987 -83.828,-24.181c-14.872,6.72 -17.577,29.554 -17.577,42.988c0,13.433 7.365,110.138 12.169,126.281c15.873,53.336 72.376,71.358 124.413,65.574c2.66,-0.395 5.357,-0.759 8.089,-1.097c-2.68,0.429 -5.379,0.796 -8.089,1.097c-76.259,11.294 -143.984,39.085 -55.158,137.972c97.708,101.165 133.908,-21.692 152.484,-83.983c18.576,62.291 39.972,180.718 150.734,83.983c83.174,-83.983 22.851,-126.674 -53.408,-137.969c-2.71,-0.302 -5.409,-0.667 -8.089,-1.096c2.732,0.337 5.429,0.702 8.089,1.096c52.037,5.785 108.54,-12.239 124.413,-65.574c4.804,-16.142 12.169,-112.847 12.169,-126.281c-0,-13.434 -2.705,-36.267 -17.577,-42.988c-12.85,-5.806 -32.45,-12.09 -83.829,24.181c-53.634,37.864 -111.319,114.635 -132.502,155.831Z"/></svg>
  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://s2f.kytta.dev/?text=VxWorks%205.4%20Device%20Driver%20Development%20https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/"
      title=""
      aria-label=""
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://reddit.com/submit/?url=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;resubmit=true&amp;title=VxWorks%205.4%20Device%20Driver%20Development"
      title="Submit to Reddit"
      aria-label="Submit to Reddit"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M201.5 305.5c-13.8 0-24.9-11.1-24.9-24.6 0-13.8 11.1-24.9 24.9-24.9 13.6 0 24.6 11.1 24.6 24.9 0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4 0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7 0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9 0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5 0 52.6 59.2 95.2 132 95.2 73.1 0 132.3-42.6 132.3-95.2 0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6 0-2.2-2.2-6.1-2.2-8.3 0-2.5 2.5-2.5 6.4 0 8.6 22.8 22.8 87.3 22.8 110.2 0 2.5-2.2 2.5-6.1 0-8.6-2.2-2.2-6.1-2.2-8.3 0zm7.7-75c-13.6 0-24.6 11.1-24.6 24.9 0 13.6 11.1 24.6 24.6 24.6 13.8 0 24.9-11.1 24.9-24.6 0-13.8-11-24.9-24.9-24.9z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://pinterest.com/pin/create/bookmarklet/?url=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;description=VxWorks%205.4%20Device%20Driver%20Development"
      title="Pin on Pinterest"
      aria-label="Pin on Pinterest"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M496 256c0 137-111 248-248 248-25.6 0-50.2-3.9-73.4-11.1 10.1-16.5 25.2-43.5 30.8-65 3-11.6 15.4-59 15.4-59 8.1 15.4 31.7 28.5 56.8 28.5 74.8 0 128.7-68.8 128.7-154.3 0-81.9-66.9-143.2-152.9-143.2-107 0-163.9 71.8-163.9 150.1 0 36.4 19.4 81.7 50.3 96.1 4.7 2.2 7.2 1.2 8.3-3.3.8-3.4 5-20.3 6.9-28.1.6-2.5.3-4.7-1.7-7.1-10.1-12.5-18.3-35.3-18.3-56.6 0-54.7 41.4-107.6 112-107.6 60.9 0 103.6 41.5 103.6 100.9 0 67.1-33.9 113.6-78 113.6-24.3 0-42.6-20.1-36.7-44.8 7-29.5 20.5-61.3 20.5-82.6 0-19-10.2-34.9-31.4-34.9-24.9 0-44.9 25.7-44.9 60.2 0 22 7.4 36.8 7.4 36.8s-24.5 103.8-29 123.2c-5 21.4-3 51.6-.9 71.2C65.4 450.9 0 361.1 0 256 0 119 111 8 248 8s248 111 248 248z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://www.facebook.com/sharer/sharer.php?u=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;quote=VxWorks%205.4%20Device%20Driver%20Development"
      title="Share on Facebook"
      aria-label="Share on Facebook"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="mailto:?body=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;subject=VxWorks%205.4%20Device%20Driver%20Development"
      title="Send via email"
      aria-label="Send via email"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://api.whatsapp.com/send?text=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;resubmit=true&amp;title=VxWorks%205.4%20Device%20Driver%20Development"
      title="Share via WhatsApp"
      aria-label="Share via WhatsApp"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>

  </span>


    </a>
      
    
      
      <a
      target="_blank"
      class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800"
      href="https://t.me/share/url?url=https://www.kad8.com/bsp/vxworks-5-4-device-driver-development/&amp;resubmit=true&amp;title=VxWorks%205.4%20Device%20Driver%20Development"
      title="Share via Telegram"
      aria-label="Share via Telegram"
      >
      

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z"/></svg>

  </span>


    </a>
      
    
  </section>


        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/featured-VxWorks-on-Zynq-UltraScale-MPSoC_hu12834213363066354496.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/">Using VxWorks BSP With Zynq 7000 Ap Soc</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-10-05T16:44:42&#43;08:00">5 October 2024</time><span class="px-2 text-primary-500">&middot;</span><span>4167 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">20 mins</span>
  

  
  
</div>





<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/vxworks/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    VxWorks
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/zynq-7000/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Zynq-7000
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/arm/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    ARM
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/training/kernel-shell-usage/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/training/kernel-shell-usage/featured-Kernel-Shell-Usage_hu14930298429651486782.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/training/kernel-shell-usage/">Kernel Shell Usage</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-10-05T15:53:47&#43;08:00">5 October 2024</time><span class="px-2 text-primary-500">&middot;</span><span>845 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">4 mins</span>
  

  
  
</div>





<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/vxworks/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    VxWorks
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/shell/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Shell
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/training/kernel-shell-configuration-and-commands/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/training/kernel-shell-configuration-and-commands/featured-Kernel-Shell-Configuration-and-Commands_hu16109129624057730151.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/training/kernel-shell-configuration-and-commands/">Kernel Shell Configuration and Commands</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  





  



  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-10-05T15:42:20&#43;08:00">5 October 2024</time><span class="px-2 text-primary-500">&middot;</span><span>467 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">3 mins</span>
  

  
  
</div>





<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/vxworks/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    VxWorks
  </span>
</span>
  </span>
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/shell/&#34;,'_self');">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Shell
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_bsp\/vxworks-5-4-device-driver-development\/index.md"
        var oid_likes = "likes_bsp\/vxworks-5-4-device-driver-development\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js" integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q&#43;oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/bsp/using-vxworks-bsp-with-zynq-7000-ap-soc/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Using VxWorks BSP With Zynq 7000 Ap Soc</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-10-05T16:44:42&#43;08:00">5 October 2024</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/bsp/booting-vxworks-with-altera-cyclone-v/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Boot VxWorks With Altera Cyclone V</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-10-07T15:04:11&#43;08:00">7 October 2024</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://www.vxworks.net/" target="_blank" rel="noopener noreferrer">VxWorks</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://www.gaitpu.com/" target="_blank" rel="noopener noreferrer">AI</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js" integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh&#43;sCQ0E53ghYrxgYqw&#43;0GCRyIEpA=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="https://www.kad8.com/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
